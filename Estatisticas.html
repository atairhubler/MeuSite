<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estatísticas</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" type="text/css" href="stylesEstatistica.css">
</head>
<body>
    <header>       
        <img src="be3.png" alt="Logo">
        <h1>Estatísticas de Check-ins</h1>
    </header>

    <section class="botao-container">
        <section id="voltar-dashboard">
            <button onclick="window.location.href='MeuSite.html'">Voltar ao Dashboard</button>
        </section>
    </section>

    <!-- Container para gráficos e tabela -->
    <section class="container tabelas-linha">
        <!-- Tabela de check-ins -->
        <section class="tabela-container">
            <h2>Tabela de Check-ins de Hoje</h2>
            <table id="tabelaCheckins">
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>Check-ins</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Os dados da tabela serão preenchidos aqui -->
                </tbody>
            </table>
        </section>

        <!-- Gráfico de Barras -->
        <section class="grafico-container">
            <canvas id="graficoCheckinsDia" width="400" height="200"></canvas>
        </section>
    </section>

    <!-- Novo container para o gráfico de Linhas -->
    <section class="grafico-linhas-container">
        <canvas id="graficoEstatisticas" width="400" height="200"></canvas>
    </section>

    <script>
        let graficoLinhas = null;
        let graficoBarras = null;
        let barColors = [];

        function groupByMonth(data) {
            const groupedData = {};

            data.forEach(item => {
                const cliente = item.cliente;
                const date = item.data;
                const [year, month] = date.split("-");
                const monthKey = `${year}-${month}`;

                if (!groupedData[cliente]) {
                    groupedData[cliente] = {};
                }

                if (!groupedData[cliente][monthKey]) {
                    groupedData[cliente][monthKey] = 0;
                }

                groupedData[cliente][monthKey] += item.quantidadeCheckin;
            });

            return groupedData;
        }

        function filterTodayData(data) {
            const today = new Date();
            const startOfDay = new Date(today.setHours(0, 0, 0, 0));
            const endOfDay = new Date(today.setHours(23, 59, 59, 999));
            const startOfDayStr = startOfDay.toISOString().split('T')[0];
            const endOfDayStr = endOfDay.toISOString().split('T')[0];

            return data.filter(item => {
                const itemDate = item.data;
                return itemDate >= startOfDayStr && itemDate <= endOfDayStr;
            });
        }

        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        function generateBarColors(data) {
            if (barColors.length === 0) {
                barColors = data.map(() => getRandomColor());
            }
        }

        function updateTable(clientes, checkinsDia) {
            const tabelaBody = document.getElementById('tabelaCheckins').getElementsByTagName('tbody')[0];
            tabelaBody.innerHTML = '';

            clientes.forEach((cliente, index) => {
                const row = tabelaBody.insertRow();
                const cellCliente = row.insertCell(0);
                const cellCheckins = row.insertCell(1);

                cellCliente.textContent = cliente;
                cellCheckins.textContent = checkinsDia[index];
            });
        }

        async function fetchData() {
            try {
                const response = await fetch('https://localhost:7272/EstatisticaCheckin?startDate=10%2F03%2F2024&endDate=20%2F03%2F2025');
                
                if (!response.ok) {
                    throw new Error('Erro ao buscar dados');
                }

                const data = await response.json();
                
                const todayData = filterTodayData(data);
                const clientes = todayData.map(item => item.cliente);
                const checkinsDia = todayData.map(item => item.quantidadeCheckin);

                generateBarColors(todayData);

                if (graficoBarras) {
                    graficoBarras.data.labels = clientes;
                    graficoBarras.data.datasets[0].data = checkinsDia;
                    graficoBarras.data.datasets[0].backgroundColor = barColors;
                    graficoBarras.update();
                } else {
                    const ctxBar = document.getElementById('graficoCheckinsDia').getContext('2d');
                    graficoBarras = new Chart(ctxBar, {
                        type: 'bar',
                        data: {
                            labels: clientes,
                            datasets: [{
                                label: 'Check-ins de Hoje',
                                data: checkinsDia,
                                backgroundColor: barColors,
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Clientes'
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'Quantidade de Check-ins'
                                    },
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }

                updateTable(clientes, checkinsDia);

            } catch (error) {
                console.error("Erro ao buscar dados da API:", error);
            }
        }

        async function fetchDataLine() {
            try {
                const response = await fetch('https://localhost:7272/EstatisticaCheckin?startDate=10%2F03%2F2024&endDate=20%2F03%2F2025');
                
                if (!response.ok) {
                    throw new Error('Erro ao buscar dados');
                }

                const data = await response.json();
                
                const groupedData = groupByMonth(data);

                const months = Object.keys(groupedData[Object.keys(groupedData)[0]]);
                const datasets = [];

                Object.keys(groupedData).forEach(cliente => {
                    const checkins = months.map(month => groupedData[cliente][month] || 0);

                    datasets.push({
                        label: cliente,
                        data: checkins,
                        fill: false,
                        borderColor: getRandomColor(),
                        tension: 0.1
                    });
                });

                if (graficoLinhas) {
                    graficoLinhas.data.labels = months;
                    graficoLinhas.data.datasets = datasets;
                    graficoLinhas.update();
                } else {
                    const ctxLine = document.getElementById('graficoEstatisticas').getContext('2d');
                    graficoLinhas = new Chart(ctxLine, {
                        type: 'line',
                        data: {
                            labels: months,
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Mês/Ano'
                                    },
                                    ticks: {
                                        autoSkip: true,
                                        maxTicksLimit: 6,
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'Quantidade de Check-ins'
                                    },
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }

            } catch (error) {
                console.error("Erro ao buscar dados da API:", error);
            }
        }

        fetchData();
        fetchDataLine();
        setInterval(fetchData, 5000);
        setInterval(fetchDataLine, 3600000);
    </script>
</body>
</html>
